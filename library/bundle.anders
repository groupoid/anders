{- Fiber Bundle: https://groupoid.space/math/bundle/
   - Fiber Bundle;
   - Trivial Fiber Bundle, Bundle=Pi;
   - Local F-Bundle (4 definitions).

   HoTT 2.3 Type families are fibrations

   Copyright (c) Groupoid Infinity, 2014-2022. -}

module bundle where
import library/path
import library/sigma
import library/iso
import library/pullback
import library/coequalizer
option girard true

def Family (B : U) : Uâ‚ := B â†’ U
def Fibration (B : U) : Uâ‚ := Î£ (X : U), X â†’ B

def encode (B : U) (F : B â†’ U) (y : B) : fiber (Sigma B F) B (prâ‚ B F) y â†’ F y
 := \(x : fiber (Sigma B F) B (prâ‚ B F) y), subst B F x.1.1 y (<i> x.2 @ -i) x.1.2

def decode (B : U) (F : B â†’ U) (y : B) : F y â†’ fiber (Sigma B F) B (prâ‚ B F) y
 := \(x : F y), ((y, x), idp B y)

def decode-encode (B : U) (F : B â†’ U) (y : B) (x : F y)
  : Path (F y) (transp (<i> F (idp B y @ i)) 0 x) x
 := <j> transp (<i> F y) j x

def encode-decode (B : U) (F : B â†’ U) (y : B) (x : fiber (Sigma B F) B (prâ‚ B F) y)
  : Path (fiber (Sigma B F) B (prâ‚ B F) y) ((y, encode B F y x), idp B y) x
 := <i> ((x.2 @ i, transp (<j> F (x.2 @ i âˆ¨ -j)) i x.1.2), <j> x.2 @ i âˆ§ j)

-- [Sokhatsky, MÃ¶rtberg] 2018 CCHM right fiber version

def Bundle=Pi (B : U) (F : B â†’ U) (y : B) : PathP (<_> U) (fiber (Sigma B F) B (prâ‚ B F) y) (F y)
 := isoPath (fiber (Sigma B F) B (prâ‚ B F) y) (F y) (encode B F y) (decode B F y) (decode-encode B F y) (encode-decode B F y)

-- Definition (1) Dependent
def isFBundle1 (B: U) (p: B â†’ U) (F: U): Uâ‚
 := Î£ (_: Î  (b: B), isContr (PathP (<_>U) (p b) F)), (Î  (x: Sigma B p), B)

-- Definition (2) Dependent
def isFBundle2 (B: U) (p: B â†’ U) (F: U): U
 := Î£ (v: U) (w: surjective v B), (Î  (x: v), PathP (<_>U) (p (w.1 x)) F)

-- Definition (3) Non-Dependent
def imâ‚ (A B: U) (f: A â†’ B): U := Î£ (b: B), ||â‚‹â‚ (Î  (a : A), Path B (f a) b)
def BAut (F: U): U := imâ‚ ğŸ U (Î» (x: ğŸ), F)
def ğŸ-Imâ‚ (A B: U) (f: A â†’ B): imâ‚ A B f â†’ B := Î» (x : imâ‚ A B f), x.1
def ğŸ-BAut (F: U): BAut F â†’ U := ğŸ-Imâ‚ ğŸ U (Î» (x: ğŸ), F)
def classify (E: U) (A' A: U) (E': A' â†’ U) (E: A â†’ U) (f: A' â†’ A): U := Î (x: A'), Path U (E'(x)) (E(f(x)))
def isFBundle3 (E B: U) (p: E â†’ B) (F: U): Uâ‚ := Î£ (X: B â†’ BAut F), classify E B (BAut F) (Î» (b: B), fiber E B p b) (ğŸ-BAut F) X

-- Definition (4) Non-Dependent
def isFBundle4 (E B: U) (p: E â†’ B) (F: U): Uâ‚
 := Î£ (X: U) (v: surjective X B) (v': prod X F â†’ E), pullbackSq (prod X F) E X B p v.1 v' (Î» (x: prod X F), x.1)
