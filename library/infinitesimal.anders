{- The modality of shape infinitesimal in cohesive infinity topos.
   - \Im modality type.

   HoTT 7.7 Modalities
   Felix Cherubini PhD

   https://arxiv.org/pdf/1806.05966.pdf

   Copyright (c) Groupoid Infinity, 2014-2022. -}

module infinitesimal where
import library/path
import library/iso

-- [Cherubini] 2018 de Rham Stack

def Î¹ (A : U) (a : A) : â„‘ A := â„‘-unit a
def Î¼ (A : U) (a : â„‘ (â„‘ A)) := â„‘-join a

def is-coreduced (A : U) : U := isEquiv A (â„‘ A) (Î¹ A)
def â„‘-coreduced (A : U) : is-coreduced (â„‘ A) := isoToEquiv (â„‘ A) (â„‘ (â„‘ A)) (Î¹ (â„‘ A)) (Î¼ A) (Î» (x : â„‘ (â„‘ A)), <_> x) (Î» (y : â„‘ A), <_> y)
def ind-â„‘Î² (A : U) (B : â„‘ A â†’ U) (f : Î  (a : A), â„‘ (B (Î¹ A a))) (a : A) : Path (â„‘ (B (Î¹ A a))) (ind-â„‘ A B f (Î¹ A a)) (f a) := <_> f a

def trans-â„‘ (A : I â†’ U) (a : A 0) : â„‘ (A 1) := â„‘-unit (transp (<i> A i) 0 a)
def trans-â„‘â€² (A : I â†’ U) (a : A 0) : â„‘ (A 1) := transp (<i> â„‘ (A i)) 0 (â„‘-unit a)
def trans-â„‘-is-correct (A : I â†’ U) (a : A 0) : Path (â„‘ (A 1)) (trans-â„‘ A a) (trans-â„‘â€² A a) := <_> trans-â„‘ A a

def â„‘-ind (A : U) (B : â„‘ A â†’ U) (c : Î  (a : â„‘ A), is-coreduced (B a)) (f : Î  (a : A), B (Î¹ A a)) (a : â„‘ A) : B a
 := (c a (ind-â„‘ A B (Î» (x : A), Î¹ (B (Î¹ A x)) (f x)) a)).1.1

def â„‘-indÎ² (A : U) (B : â„‘ A â†’ U) (c : Î  (a : â„‘ A), is-coreduced (B a)) (f : Î  (a : A), B (Î¹ A a)) (a : A)
  : Path (B (Î¹ A a)) (f a) ((â„‘-ind A B c f) (Î¹ A a))
 := <i> sec-equiv (B (Î¹ A a)) (â„‘ (B (Î¹ A a))) (Î¹ (B (Î¹ A a)), c (Î¹ A a)) (f a) @ -i

def â„‘-rec (A B : U) (c : is-coreduced B) (f : A â†’ B) : â„‘ A â†’ B
 := â„‘-ind A (Î» (_ : â„‘ A), B) (Î» (_ : â„‘ A), c) f

def â„‘-recÎ² (A B : U) (c : is-coreduced B) (f : A â†’ B) (a : A) : PathP (<_> B) (f a) ((â„‘-rec A B c f) (Î¹ A a))
 := â„‘-indÎ² A (Î» (_ : â„‘ A), B) (Î» (_ : â„‘ A), c) f a

def â„‘-recâ€² (A B : U) (f : A â†’ â„‘ B) : â„‘ A â†’ â„‘ B := ind-â„‘ A (Î» (x : â„‘ A), B) f
def â„‘-recâ€²-Î² (A B : U) (f : A â†’ â„‘ B) (x : A) : Path (â„‘ B) (â„‘-recâ€² A B f (â„‘-unit x)) (f x) := <_> f x

def â„‘-app (A B : U) (f : A â†’ B) : â„‘ A â†’ â„‘ B := â„‘-rec A (â„‘ B) (â„‘-coreduced B) (âˆ˜ A B (â„‘ B) (Î¹ B) f)
def â„‘-naturality (A B : U) (f : A â†’ B) (a : A) : Path (â„‘ B) ((Î¹ B) (f a)) ((â„‘-app A B f) (Î¹ A a))
 := <_> â„‘-unit (f a) -- slightly surprisingly, but it computes

def ~ (X : U) (a xâ€² : X) : U := Path (â„‘ X) (Î¹ X a) (Î¹ X xâ€²)
def ğ”» (X : U) (a : X) : U := Î£ (xâ€² : X), ~ X a xâ€²
def unitDisc (X : U) (x : â„‘ X) : U := Î£ (xâ€² : X), Path (â„‘ X) x (Î¹ X xâ€²)
def starDisc (X : U) (x : X) : ğ”» X x := (x, idp (â„‘ X) (Î¹ X x))
def Tâˆ (A : U) : U := Î£ (a : A), ğ”» A a

def inf-prox-ap (X Y : U) (f : X â†’ Y) (x xâ€² : X) (p : ~ X x xâ€²) : ~ Y (f x) (f xâ€²) :=
<i> â„‘-app X Y f (p @ i)

axiom inf-prox-comp (X Y Z : U) (f : Y â†’ Z) (g : X â†’ Y) (x xâ€² : X) (p : ~ X x xâ€²) :
  Path (~ Z (f (g x)) (f (g xâ€²))) (inf-prox-ap X Z (âˆ˜ X Y Z f g) x xâ€² p)
       (inf-prox-ap Y Z f (g x) (g xâ€²) (inf-prox-ap X Y g x xâ€² p))

def d (X Y : U) (f : X â†’ Y) (x : X) (Îµ : ğ”» X x) : ğ”» Y (f x)
 := (f Îµ.1, inf-prox-ap X Y f x Îµ.1 Îµ.2)

theorem diff-comp (A B C : U) (f : A â†’ B) (g : B â†’ C) (x : A)
  : Path ((ğ”» A x â†’ ğ”» C ((âˆ˜ A B C g f) x))) (d A C (âˆ˜ A B C g f) x)
         (âˆ˜ (ğ”» A x) (ğ”» B (f x)) (ğ”» C ((âˆ˜ A B C g f) x)) (d B C g (f x)) (d A B f x)) :=
<i> Î» (Îµ : ğ”» A x), (g (f Îµ.1), inf-prox-comp A B C g f x Îµ.1 Îµ.2 @ i)
