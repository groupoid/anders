{- The modality of shape infinitesimal in cohesive infinity topos.
   - \Im modality type.

   HoTT 7.7 Modalities
   Felix Cherubini PhD

   https://arxiv.org/pdf/1806.05966.pdf

   Copyright (c) Groupoid Infinity, 2014-2022. -}

module infinitesimal where
import library/path
import library/iso

-- [Cherubini] 2018 de Rham Stack

def Œπ (A : U) (a : A) : ‚Ñë A := ‚Ñë-unit a
def Œº (A : U) (a : ‚Ñë (‚Ñë A)) := ‚Ñë-join a

def is-coreduced (A : U) : U := isEquiv A (‚Ñë A) (Œπ A)
def ‚Ñë-coreduced (A : U) : is-coreduced (‚Ñë A) := isoToEquiv (‚Ñë A) (‚Ñë (‚Ñë A)) (Œπ (‚Ñë A)) (Œº A) (Œª (x : ‚Ñë (‚Ñë A)), <_> x) (Œª (y : ‚Ñë A), <_> y)
def ind-‚ÑëŒ≤ (A : U) (B : ‚Ñë A ‚Üí U) (f : Œ† (a : A), ‚Ñë (B (Œπ A a))) (a : A) : Path (‚Ñë (B (Œπ A a))) (ind-‚Ñë A B f (Œπ A a)) (f a) := <_> f a

def trans-‚Ñë (A : I ‚Üí U) (a : A 0) : ‚Ñë (A 1) := ‚Ñë-unit (transp (<i> A i) 0 a)
def trans-‚Ñë‚Ä≤ (A : I ‚Üí U) (a : A 0) : ‚Ñë (A 1) := transp (<i> ‚Ñë (A i)) 0 (‚Ñë-unit a)
def trans-‚Ñë-is-correct (A : I ‚Üí U) (a : A 0) : Path (‚Ñë (A 1)) (trans-‚Ñë A a) (trans-‚Ñë‚Ä≤ A a) := <_> trans-‚Ñë A a

def hcomp-‚Ñë (A : U) (r : I) (u : I ‚Üí Partial A r) (u‚ÇÄ : A[r ‚Ü¶ u 0]) : ‚Ñë A
 := ‚Ñë-unit (hcomp A r u (ouc u‚ÇÄ))

def hcomp-‚Ñë‚Ä≤ (A : U) (r : I) (u : I ‚Üí Partial A r) (u‚ÇÄ : A[r ‚Ü¶ u 0]) : ‚Ñë A
 := hcomp (‚Ñë A) r (Œª (i : I), [(r = 1) ‚Üí ‚Ñë-unit (u i 1=1)]) (‚Ñë-unit (ouc u‚ÇÄ))

def hcomp-‚Ñë-is-correct (A : U) (r : I) (u : I ‚Üí Partial A r) (u‚ÇÄ : A[r ‚Ü¶ u 0])
  : Path (‚Ñë A) (hcomp-‚Ñë A r u u‚ÇÄ) (hcomp-‚Ñë‚Ä≤ A r u u‚ÇÄ)
 := <_> hcomp-‚Ñë A r u u‚ÇÄ

def ‚Ñë-ind (A : U) (B : ‚Ñë A ‚Üí U) (c : Œ† (a : ‚Ñë A), is-coreduced (B a)) (f : Œ† (a : A), B (Œπ A a)) (a : ‚Ñë A) : B a
 := (c a (ind-‚Ñë A B (Œª (x : A), Œπ (B (Œπ A x)) (f x)) a)).1.1

def ‚Ñë-indŒ≤ (A : U) (B : ‚Ñë A ‚Üí U) (c : Œ† (a : ‚Ñë A), is-coreduced (B a)) (f : Œ† (a : A), B (Œπ A a)) (a : A)
  : Path (B (Œπ A a)) (f a) ((‚Ñë-ind A B c f) (Œπ A a))
 := <i> sec-equiv (B (Œπ A a)) (‚Ñë (B (Œπ A a))) (Œπ (B (Œπ A a)), c (Œπ A a)) (f a) @ -i

def ‚Ñë-rec (A B : U) (c : is-coreduced B) (f : A ‚Üí B) : ‚Ñë A ‚Üí B
 := ‚Ñë-ind A (Œª (_ : ‚Ñë A), B) (Œª (_ : ‚Ñë A), c) f

def ‚Ñë-recŒ≤ (A B : U) (c : is-coreduced B) (f : A ‚Üí B) (a : A) : PathP (<_> B) (f a) ((‚Ñë-rec A B c f) (Œπ A a))
 := ‚Ñë-indŒ≤ A (Œª (_ : ‚Ñë A), B) (Œª (_ : ‚Ñë A), c) f a

def ‚Ñë-rec‚Ä≤ (A B : U) (f : A ‚Üí ‚Ñë B) : ‚Ñë A ‚Üí ‚Ñë B := ind-‚Ñë A (Œª (x : ‚Ñë A), B) f
def ‚Ñë-rec‚Ä≤-Œ≤ (A B : U) (f : A ‚Üí ‚Ñë B) (x : A) : Path (‚Ñë B) (‚Ñë-rec‚Ä≤ A B f (‚Ñë-unit x)) (f x) := <_> f x

def ‚Ñë-app (A B : U) (f : A ‚Üí B) : ‚Ñë A ‚Üí ‚Ñë B := ‚Ñë-rec A (‚Ñë B) (‚Ñë-coreduced B) (‚àò A B (‚Ñë B) (Œπ B) f)
def ‚Ñë-naturality (A B : U) (f : A ‚Üí B) (a : A) : Path (‚Ñë B) ((Œπ B) (f a)) ((‚Ñë-app A B f) (Œπ A a))
 := <_> ‚Ñë-unit (f a) -- slightly surprisingly, but it computes

def ~ (X : U) (a x‚Ä≤ : X) : U := Path (‚Ñë X) (Œπ X a) (Œπ X x‚Ä≤)
def ùîª (X : U) (a : X) : U := Œ£ (x‚Ä≤ : X), ~ X a x‚Ä≤
def unitDisc (X : U) (x : ‚Ñë X) : U := Œ£ (x‚Ä≤ : X), Path (‚Ñë X) x (Œπ X x‚Ä≤)
def starDisc (X : U) (x : X) : ùîª X x := (x, idp (‚Ñë X) (Œπ X x))
def T‚àû (A : U) : U := Œ£ (a : A), ùîª A a

def inf-prox-ap (X Y : U) (f : X ‚Üí Y) (x x‚Ä≤ : X) (p : ~ X x x‚Ä≤) : ~ Y (f x) (f x‚Ä≤) := <i> ‚Ñë-app X Y f (p @ i)

axiom inf-prox-comp (X Y Z : U) (f : Y ‚Üí Z) (g : X ‚Üí Y) (x x‚Ä≤ : X) (p : ~ X x x‚Ä≤)
    :  Path (~ Z (f (g x)) (f (g x‚Ä≤)))
            (inf-prox-ap X Z (‚àò X Y Z f g) x x‚Ä≤ p)
            (inf-prox-ap Y Z f (g x) (g x‚Ä≤) (inf-prox-ap X Y g x x‚Ä≤ p))

def d (X Y : U) (f : X ‚Üí Y) (x : X) (Œµ : ùîª X x) : ùîª Y (f x) := (f Œµ.1, inf-prox-ap X Y f x Œµ.1 Œµ.2)

theorem diff-comp (A B C : U) (f : A ‚Üí B) (g : B ‚Üí C) (x : A)
  : Path ((ùîª A x ‚Üí ùîª C ((‚àò A B C g f) x))) (d A C (‚àò A B C g f) x)
         (‚àò (ùîª A x) (ùîª B (f x)) (ùîª C (g (f x))) (d B C g (f x)) (d A B f x))
 := <i> Œª (Œµ : ùîª A x), (g (f Œµ.1), inf-prox-comp A B C g f x Œµ.1 Œµ.2 @ i)
